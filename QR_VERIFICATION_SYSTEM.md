# QR Code Verification System
> **Document Authenticity** — Scannable verification for every deed

---

## Overview

Every deed generated by DeedPro will include:

1. **Unique Document ID** — Human-readable short code (e.g., `DOC-2026-A7X9K`)
2. **QR Code** — Scannable link to verification page
3. **Content Hash** — SHA-256 of document content
4. **Verification Page** — Public URL showing document metadata

```
┌─────────────────────────────────────┐
│                                     │
│         GRANT DEED                  │
│                                     │
│         ... content ...             │
│                                     │
│  ┌─────────┐                        │
│  │ ▄▄▄▄▄▄▄ │  Verify: deedpro.com   │
│  │ █ QR  █ │  ID: DOC-2026-A7X9K    │
│  │ ▀▀▀▀▀▀▀ │                        │
│  └─────────┘                        │
└─────────────────────────────────────┘
```

---

## Database Schema

### Table: document_authenticity

```sql
-- backend/migrations/001_document_authenticity.sql

CREATE TABLE IF NOT EXISTS document_authenticity (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Human-readable identifier
    short_code VARCHAR(16) UNIQUE NOT NULL,  -- e.g., "DOC-2026-A7X9K"
    
    -- Document metadata
    document_type VARCHAR(50) NOT NULL,       -- "grant_deed", "quitclaim_deed", etc.
    property_address TEXT,
    property_apn VARCHAR(50),
    county VARCHAR(100),
    
    -- Parties (for display, not sensitive)
    grantor_display VARCHAR(255),             -- "JOHN S." (abbreviated)
    grantee_display VARCHAR(255),             -- "JANE S." (abbreviated)
    
    -- Verification data
    content_hash VARCHAR(64) NOT NULL,        -- SHA-256 of deed content
    pdf_hash VARCHAR(64),                     -- SHA-256 of final PDF
    
    -- Timestamps
    generated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    first_verified_at TIMESTAMP WITH TIME ZONE,
    last_verified_at TIMESTAMP WITH TIME ZONE,
    verification_count INTEGER DEFAULT 0,
    
    -- Ownership
    organization_id UUID,                     -- If multi-tenant
    created_by_user_id INTEGER REFERENCES users(id),
    
    -- Status
    status VARCHAR(20) DEFAULT 'active',      -- active, revoked, superseded
    revoked_at TIMESTAMP WITH TIME ZONE,
    revoked_reason TEXT,
    superseded_by UUID REFERENCES document_authenticity(id),
    
    -- Reference to deed record
    deed_id INTEGER REFERENCES deeds(id),
    
    -- Constraints
    CONSTRAINT valid_status CHECK (status IN ('active', 'revoked', 'superseded'))
);

-- Indexes
CREATE INDEX idx_doc_auth_short_code ON document_authenticity(short_code);
CREATE INDEX idx_doc_auth_deed_id ON document_authenticity(deed_id);
CREATE INDEX idx_doc_auth_status ON document_authenticity(status);
CREATE INDEX idx_doc_auth_created_by ON document_authenticity(created_by_user_id);
```

### Table: verification_log

```sql
-- Audit trail of all verification attempts

CREATE TABLE IF NOT EXISTS verification_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    document_id UUID REFERENCES document_authenticity(id) ON DELETE CASCADE,
    
    -- Verification details
    verified_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    verification_method VARCHAR(20) NOT NULL,  -- 'qr_scan', 'manual', 'api'
    result VARCHAR(20) NOT NULL,               -- 'valid', 'invalid', 'revoked', 'not_found'
    
    -- Request metadata (anonymized)
    ip_hash VARCHAR(64),                       -- Hashed IP for abuse detection
    user_agent_hash VARCHAR(64),               -- Hashed UA
    country_code VARCHAR(2),                   -- From IP geolocation (optional)
    
    -- Error details (if any)
    error_message TEXT
);

-- Index for analytics
CREATE INDEX idx_verification_log_doc ON verification_log(document_id);
CREATE INDEX idx_verification_log_time ON verification_log(verified_at);
```

---

## Short Code Generation

```python
# backend/utils/short_code.py

import random
import string
from datetime import datetime

def generate_short_code() -> str:
    """
    Generate a human-readable document ID.
    Format: DOC-YYYY-XXXXX
    
    Example: DOC-2026-A7X9K
    """
    year = datetime.now().year
    chars = string.ascii_uppercase + string.digits
    # Remove ambiguous characters: 0, O, I, L, 1
    chars = chars.replace('0', '').replace('O', '').replace('I', '').replace('L', '').replace('1', '')
    random_part = ''.join(random.choices(chars, k=5))
    return f"DOC-{year}-{random_part}"


def generate_content_hash(content: str) -> str:
    """
    Generate SHA-256 hash of content.
    """
    import hashlib
    return hashlib.sha256(content.encode('utf-8')).hexdigest()
```

---

## QR Code Generation

```python
# backend/utils/qr_generator.py

import qrcode
import io
import base64

def generate_verification_qr(short_code: str, base_url: str = None) -> str:
    """
    Generate QR code as base64 data URL.
    
    Args:
        short_code: Document short code (e.g., "DOC-2026-A7X9K")
        base_url: Base URL for verification (default: production URL)
    
    Returns:
        Base64 data URL for embedding in HTML/PDF
    """
    if not base_url:
        base_url = "https://deedpro-frontend-new.vercel.app"
    
    verification_url = f"{base_url}/verify/{short_code}"
    
    # Generate QR code
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_M,
        box_size=10,
        border=2,
    )
    qr.add_data(verification_url)
    qr.make(fit=True)
    
    # Create image
    img = qr.make_image(fill_color="black", back_color="white")
    
    # Convert to base64
    buffer = io.BytesIO()
    img.save(buffer, format='PNG')
    img_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')
    
    return f"data:image/png;base64,{img_base64}"
```

Add to requirements.txt:
```
qrcode[pil]==7.4.2
```

---

## API Endpoints

### 1. Public Verification Endpoint (No Auth)

```python
# backend/main.py (or backend/api/verification.py)

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import Optional
from database import get_db_connection
from datetime import datetime
import hashlib

router = APIRouter(prefix="/api/verify", tags=["verification"])

class VerificationResponse(BaseModel):
    valid: bool
    status: str  # "valid", "revoked", "not_found"
    document: Optional[dict] = None
    message: str

@router.get("/{short_code}")
async def verify_document(short_code: str, method: str = "manual"):
    """
    Public endpoint to verify document authenticity.
    No authentication required.
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        # Look up document
        cursor.execute("""
            SELECT 
                id, short_code, document_type, property_address, property_apn,
                county, grantor_display, grantee_display, content_hash,
                generated_at, status, revoked_at, revoked_reason,
                verification_count
            FROM document_authenticity
            WHERE short_code = %s
        """, (short_code.upper(),))
        
        doc = cursor.fetchone()
        
        # Log verification attempt
        log_verification(cursor, doc, short_code, method)
        
        if not doc:
            conn.commit()
            return VerificationResponse(
                valid=False,
                status="not_found",
                message="Document not found. Please check the ID and try again."
            )
        
        if doc['status'] == 'revoked':
            conn.commit()
            return VerificationResponse(
                valid=False,
                status="revoked",
                message=f"This document was revoked on {doc['revoked_at'].strftime('%B %d, %Y')}.",
                document={
                    "type": format_document_type(doc['document_type']),
                    "revokedAt": doc['revoked_at'].isoformat(),
                    "reason": doc['revoked_reason']
                }
            )
        
        # Update verification stats
        cursor.execute("""
            UPDATE document_authenticity
            SET 
                verification_count = verification_count + 1,
                last_verified_at = NOW(),
                first_verified_at = COALESCE(first_verified_at, NOW())
            WHERE id = %s
        """, (doc['id'],))
        
        conn.commit()
        
        return VerificationResponse(
            valid=True,
            status="valid",
            message="Document verified successfully.",
            document={
                "id": doc['short_code'],
                "type": format_document_type(doc['document_type']),
                "propertyAddress": doc['property_address'],
                "apn": doc['property_apn'],
                "county": doc['county'],
                "grantor": doc['grantor_display'],
                "grantee": doc['grantee_display'],
                "generatedAt": doc['generated_at'].isoformat(),
                "contentHash": doc['content_hash'][:16] + "...",  # Abbreviated
                "verificationCount": doc['verification_count'] + 1
            }
        )
        
    except Exception as e:
        conn.rollback()
        raise HTTPException(status_code=500, detail=str(e))
    finally:
        cursor.close()
        conn.close()


def log_verification(cursor, doc, short_code: str, method: str):
    """Log verification attempt for audit trail."""
    cursor.execute("""
        INSERT INTO verification_log 
            (document_id, verification_method, result)
        VALUES 
            (%s, %s, %s)
    """, (
        doc['id'] if doc else None,
        method,
        'valid' if doc and doc['status'] == 'active' else 
        'revoked' if doc and doc['status'] == 'revoked' else 'not_found'
    ))


def format_document_type(doc_type: str) -> str:
    """Format document type for display."""
    mapping = {
        'grant_deed': 'Grant Deed',
        'quitclaim_deed': 'Quitclaim Deed',
        'interspousal_transfer': 'Interspousal Transfer Deed',
        'warranty_deed': 'Warranty Deed',
        'tax_deed': 'Tax Deed',
    }
    return mapping.get(doc_type, doc_type.replace('_', ' ').title())
```

### 2. Create Authenticity Record (Internal)

```python
# Called during deed generation

async def create_document_authenticity(
    deed_id: int,
    document_type: str,
    html_content: str,
    property_address: str,
    apn: str,
    county: str,
    grantor: str,
    grantee: str,
    user_id: int
) -> dict:
    """
    Create authenticity record and return QR code data.
    Called during deed PDF generation.
    """
    from utils.short_code import generate_short_code, generate_content_hash
    from utils.qr_generator import generate_verification_qr
    
    short_code = generate_short_code()
    content_hash = generate_content_hash(html_content)
    
    # Abbreviate names for privacy
    grantor_display = abbreviate_name(grantor)
    grantee_display = abbreviate_name(grantee)
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        cursor.execute("""
            INSERT INTO document_authenticity (
                short_code, document_type, property_address, property_apn,
                county, grantor_display, grantee_display, content_hash,
                deed_id, created_by_user_id
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            RETURNING id, short_code
        """, (
            short_code, document_type, property_address, apn,
            county, grantor_display, grantee_display, content_hash,
            deed_id, user_id
        ))
        
        result = cursor.fetchone()
        conn.commit()
        
        # Generate QR code
        qr_data = generate_verification_qr(short_code)
        
        return {
            "id": result['id'],
            "short_code": result['short_code'],
            "qr_code_data": qr_data,
            "verification_url": f"https://deedpro-frontend-new.vercel.app/verify/{short_code}"
        }
        
    finally:
        cursor.close()
        conn.close()


def abbreviate_name(name: str) -> str:
    """Abbreviate name for privacy (e.g., 'JOHN SMITH' -> 'JOHN S.')"""
    if not name:
        return ""
    parts = name.strip().split()
    if len(parts) >= 2:
        return f"{parts[0]} {parts[-1][0]}."
    return name
```

---

## Frontend: Verification Page

### File: `frontend/src/app/verify/[code]/page.tsx`

```tsx
// frontend/src/app/verify/[code]/page.tsx

'use client';

import { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import { 
  CheckCircle, 
  XCircle, 
  AlertTriangle, 
  Shield, 
  FileText,
  MapPin,
  Calendar,
  Hash,
  Users
} from 'lucide-react';

interface VerificationResult {
  valid: boolean;
  status: 'valid' | 'revoked' | 'not_found';
  message: string;
  document?: {
    id: string;
    type: string;
    propertyAddress: string;
    apn: string;
    county: string;
    grantor: string;
    grantee: string;
    generatedAt: string;
    contentHash: string;
    verificationCount: number;
  };
}

export default function VerifyPage() {
  const params = useParams();
  const code = params.code as string;
  
  const [result, setResult] = useState<VerificationResult | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function verify() {
      try {
        const response = await fetch(
          `${process.env.NEXT_PUBLIC_API_URL}/api/verify/${code}?method=qr_scan`
        );
        const data = await response.json();
        setResult(data);
      } catch (err) {
        setError('Unable to verify document. Please try again.');
      } finally {
        setLoading(false);
      }
    }
    
    if (code) {
      verify();
    }
  }, [code]);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-600">Verifying document...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
          <AlertTriangle className="w-16 h-16 text-amber-500 mx-auto mb-4" />
          <h1 className="text-xl font-bold text-gray-900 mb-2">Verification Error</h1>
          <p className="text-gray-600">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-12 px-4">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <Shield className="w-12 h-12 text-primary mx-auto mb-3" />
          <h1 className="text-2xl font-bold text-gray-900">Document Verification</h1>
          <p className="text-gray-600 mt-1">DeedPro Authenticity Check</p>
        </div>

        {/* Result Card */}
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          {/* Status Banner */}
          <div className={`p-6 ${
            result?.status === 'valid' 
              ? 'bg-emerald-500' 
              : result?.status === 'revoked'
              ? 'bg-red-500'
              : 'bg-amber-500'
          }`}>
            <div className="flex items-center justify-center gap-3 text-white">
              {result?.status === 'valid' ? (
                <CheckCircle className="w-8 h-8" />
              ) : result?.status === 'revoked' ? (
                <XCircle className="w-8 h-8" />
              ) : (
                <AlertTriangle className="w-8 h-8" />
              )}
              <span className="text-2xl font-bold">
                {result?.status === 'valid' 
                  ? 'Verified' 
                  : result?.status === 'revoked'
                  ? 'Revoked'
                  : 'Not Found'}
              </span>
            </div>
            <p className="text-white/90 text-center mt-2">
              {result?.message}
            </p>
          </div>

          {/* Document Details */}
          {result?.document && (
            <div className="p-6 space-y-4">
              <div className="flex items-center gap-3 pb-4 border-b">
                <div className="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <FileText className="w-5 h-5 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Document Type</p>
                  <p className="font-semibold text-gray-900">{result.document.type}</p>
                </div>
              </div>

              <div className="flex items-center gap-3 pb-4 border-b">
                <div className="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <MapPin className="w-5 h-5 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Property</p>
                  <p className="font-semibold text-gray-900">{result.document.propertyAddress}</p>
                  <p className="text-sm text-gray-500">APN: {result.document.apn} • {result.document.county} County</p>
                </div>
              </div>

              <div className="flex items-center gap-3 pb-4 border-b">
                <div className="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <Users className="w-5 h-5 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Parties</p>
                  <p className="font-semibold text-gray-900">
                    {result.document.grantor} → {result.document.grantee}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-3 pb-4 border-b">
                <div className="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <Calendar className="w-5 h-5 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Generated</p>
                  <p className="font-semibold text-gray-900">
                    {new Date(result.document.generatedAt).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    })}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center">
                  <Hash className="w-5 h-5 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Document ID</p>
                  <p className="font-mono font-semibold text-gray-900">{result.document.id}</p>
                  <p className="text-xs text-gray-400 mt-1">
                    Hash: {result.document.contentHash}
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Footer */}
          <div className="bg-gray-50 px-6 py-4 text-center">
            <p className="text-xs text-gray-500">
              {result?.document?.verificationCount && (
                <span>Verified {result.document.verificationCount} time{result.document.verificationCount !== 1 ? 's' : ''} • </span>
              )}
              Powered by <a href="https://deedpro.com" className="text-primary hover:underline">DeedPro</a>
            </p>
          </div>
        </div>

        {/* Manual Entry */}
        <div className="mt-8 text-center">
          <p className="text-sm text-gray-500 mb-2">Have a document ID?</p>
          <form 
            onSubmit={(e) => {
              e.preventDefault();
              const input = (e.target as HTMLFormElement).elements.namedItem('code') as HTMLInputElement;
              if (input.value) {
                window.location.href = `/verify/${input.value}`;
              }
            }}
            className="flex gap-2 max-w-xs mx-auto"
          >
            <input
              type="text"
              name="code"
              placeholder="DOC-2026-XXXXX"
              className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary text-sm"
            />
            <button
              type="submit"
              className="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 text-sm font-medium"
            >
              Verify
            </button>
          </form>
        </div>
      </div>
    </div>
  );
}
```

---

## Integration with Deed Generation

Update the deed generation endpoint to create authenticity record:

```python
# In main.py, update generate_grant_deed (and other deed endpoints)

@app.post("/api/generate/grant-deed-ca")
async def generate_grant_deed(data: DeedData, user_id: int = Depends(get_current_user_id)):
    # Render template
    template = env.get_template("grant_deed_ca/index.jinja2")
    
    # Create authenticity record FIRST
    auth_data = await create_document_authenticity(
        deed_id=None,  # Will update after deed saved
        document_type="grant_deed",
        html_content=str(data.dict()),  # Or hash the actual content
        property_address=data.property_address,
        apn=data.apn,
        county=data.county,
        grantor=data.grantor,
        grantee=data.grantee,
        user_id=user_id
    )
    
    # Add QR data to template context
    template_vars = {
        **data.dict(),
        "document_id": auth_data["short_code"],
        "qr_code_data": auth_data["qr_code_data"],
    }
    
    html = template.render(**template_vars)
    pdf_bytes = await render_html_to_pdf(html)
    
    return Response(content=pdf_bytes, media_type="application/pdf")
```

---

## Checklist

| Task | Status | File |
|------|--------|------|
| Create document_authenticity table | ⚪ | `backend/migrations/001_document_authenticity.sql` |
| Create verification_log table | ⚪ | Same file |
| Create short_code.py utility | ⚪ | `backend/utils/short_code.py` |
| Create qr_generator.py utility | ⚪ | `backend/utils/qr_generator.py` |
| Add qrcode to requirements.txt | ⚪ | `backend/requirements.txt` |
| Create /api/verify endpoint | ⚪ | `backend/main.py` |
| Create verification page | ⚪ | `frontend/src/app/verify/[code]/page.tsx` |
| Update deed generation to create auth record | ⚪ | `backend/main.py` |
| Update templates with QR placeholder | ✅ | Already in notary partial |
| Test full flow | ⚪ | Generate → Scan → Verify |
